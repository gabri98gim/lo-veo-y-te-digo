---
import Layout from "../layouts/Layout.astro";

const apiKey = import.meta.env.TMDB_API_KEY;

if (!apiKey) {
  console.error(
    "‚ùå ERROR CR√çTICO: No se encuentra la TMDB_API_KEY en el archivo .env",
  );
}

let movies = [];

try {
  const response = await fetch(
    `https://api.themoviedb.org/3/movie/upcoming?api_key=${apiKey}&language=es-ES&page=1`,
  );
  const data = await response.json();

  if (data.results) {
    movies = data.results;
  } else {
    console.error("‚ö†Ô∏è La API de TMDB devolvi√≥ un error:", data);
  }
} catch (error) {
  console.error("üíÄ Error de red al conectar con TMDB:", error);
}

const imageBase = "https://image.tmdb.org/t/p/w500";
---

<Layout title="Pr√≥ximos Estrenos | Lo veo y te digo">
  <section class="mb-12">
    <h1
      class="font-serif text-4xl font-bold text-gray-900 dark:text-white mb-4"
    >
      Pr√≥ximos Estrenos
    </h1>
    <p class="text-gray-600 dark:text-gray-400 max-w-2xl text-lg">
      Las pel√≠culas que est√°n a punto de llegar a la cartelera.
    </p>
  </section>

  {
    movies.length === 0 ? (
      <div class="p-8 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-lg border border-red-200 dark:border-red-800 text-center">
        <p class="font-bold text-xl mb-2">
          Ups, no se pudieron cargar los estrenos üòî
        </p>
        <p class="text-sm">Revisa la consola (posiblemente la API Key).</p>
      </div>
    ) : (
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        {movies.map((movie: any) => {
          // TRUCO: Creamos la URL de b√∫squeda en Filmaffinity
          const filmaffinitySearch = `https://www.filmaffinity.com/es/search.php?stext=${encodeURIComponent(movie.title)}`;

          return (
            // CAMBIO: Ahora es un <a> que te lleva a Filmaffinity en otra pesta√±a
            <a
              href={filmaffinitySearch}
              target="_blank"
              rel="noopener noreferrer"
              class="group relative block"
            >
              <div class="aspect-[2/3] overflow-hidden rounded-lg bg-gray-200 dark:bg-gray-800 mb-3 shadow-sm hover:shadow-xl transition-all duration-300">
                {movie.poster_path ? (
                  <img
                    src={`${imageBase}${movie.poster_path}`}
                    alt={`P√≥ster de ${movie.title}`}
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                  />
                ) : (
                  <div class="w-full h-full flex items-center justify-center text-gray-400 text-xs">
                    Sin imagen
                  </div>
                )}

                <div class="absolute top-2 right-2 bg-black/80 backdrop-blur text-white text-xs font-bold px-2 py-1 rounded border border-white/20">
                  {Math.round(movie.vote_average * 10) / 10} ‚òÖ
                </div>

                <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 bg-black/20">
                  <svg
                    class="w-12 h-12 text-white drop-shadow-lg"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                    />
                  </svg>
                </div>
              </div>

              <h3 class="font-bold text-gray-900 dark:text-white leading-tight group-hover:text-cine-gold transition-colors">
                {movie.title}
              </h3>

              <p class="text-xs text-gray-500 mt-1 flex items-center gap-1">
                <span>üìÖ Estreno: {movie.release_date}</span>
              </p>
            </a>
          );
        })}
      </div>
    )
  }
</Layout>
