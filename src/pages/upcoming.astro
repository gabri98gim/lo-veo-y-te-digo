---
import Layout from "../layouts/Layout.astro";

const apiKey = import.meta.env.TMDB_API_KEY;

// 1. Definimos las variables base fuera de los bloques para evitar errores en VS Code
let movies: any[] = [];
const today = new Date().toISOString().split("T")[0];
const sixWeeksLater = new Date();
sixWeeksLater.setDate(sixWeeksLater.getDate() + 42);
const maxDate = sixWeeksLater.toISOString().split("T")[0];

try {
  // Pedimos dos pÃ¡ginas para tener contenido suficiente
  const pages = [1, 2];
  const allResults: any[] = [];

  for (const page of pages) {
    const upcomingResponse = await fetch(
      `https://api.themoviedb.org/3/discover/movie?api_key=${apiKey}&language=es-ES&region=ES&sort_by=primary_release_date.asc&primary_release_date.gte=${today}&primary_release_date.lte=${maxDate}&page=${page}`,
    );
    const upcomingData = await upcomingResponse.json();
    if (upcomingData.results) {
      allResults.push(...upcomingData.results);
    }
  }

  // Combinamos con lo que hay ahora en cines
  const nowPlayingResponse = await fetch(
    `https://api.themoviedb.org/3/movie/now_playing?api_key=${apiKey}&language=es-ES&region=ES&page=1`,
  );
  const nowPlayingData = await nowPlayingResponse.json();

  const allMovies = [...allResults, ...(nowPlayingData.results || [])];

  // Eliminamos duplicados
  const uniqueMovies = Array.from(
    new Map(allMovies.map((m: any) => [m.id, m])).values(),
  );

  // FILTRO RELAJADO: Para que en Vercel aparezcan pelis sÃ­ o sÃ­
  movies = uniqueMovies
    .filter((m: any) => {
      const releaseDate = m.release_date;
      // Solo pedimos que tenga fecha y que tenga un pÃ³ster
      return releaseDate >= today && m.poster_path !== null;
    })
    .sort((a: any, b: any) => a.release_date.localeCompare(b.release_date));
} catch (error) {
  console.error("ðŸ’€ Error detectado:", error);
}

// Agrupar por semanas para que el diseÃ±o sea mÃ¡s limpio
const groupByWeek = (movies: any[]) => {
  const weeks: { [key: string]: any[] } = {};
  movies.forEach((movie) => {
    const date = new Date(movie.release_date);
    const weekStart = new Date(date);
    weekStart.setDate(date.getDate() - date.getDay() + 1);
    const weekKey = weekStart.toISOString().split("T")[0];

    if (!weeks[weekKey]) {
      weeks[weekKey] = [];
    }
    weeks[weekKey].push(movie);
  });
  return Object.entries(weeks).sort(([a], [b]) => a.localeCompare(b));
};

const weekGroups = groupByWeek(movies);
const imageBase = "https://image.tmdb.org/t/p/w500";
---

<Layout title="PrÃ³ximos Estrenos | Lo veo y te digo">
  <section class="mb-12">
    <h1
      class="font-serif text-4xl font-bold text-gray-900 dark:text-white mb-4"
    >
      PrÃ³ximos Estrenos (EspaÃ±a)
    </h1>
    <p class="text-gray-600 dark:text-gray-400 max-w-2xl text-lg">
      Cartelera confirmada desde hoy ({today}) hasta las prÃ³ximas semanas.
    </p>
  </section>

  {
    movies.length === 0 ? (
      <div class="p-8 bg-gray-100 dark:bg-gray-800 text-gray-500 rounded-lg text-center">
        <p class="font-bold text-xl">
          No se han encontrado estrenos comerciales para los prÃ³ximos dÃ­as ðŸ˜”
        </p>
      </div>
    ) : (
      <div class="space-y-12">
        {weekGroups.map(([weekStart, weekMovies]) => {
          const weekDate = new Date(weekStart);
          const weekEnd = new Date(weekDate);
          weekEnd.setDate(weekEnd.getDate() + 6);

          const weekLabel = `${weekDate.toLocaleDateString("es-ES", { day: "numeric", month: "short" })} - ${weekEnd.toLocaleDateString("es-ES", { day: "numeric", month: "short" })}`;

          return (
            <div>
              <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-6 pb-2 border-b-2 border-yellow-500/50">
                Semana: {weekLabel}
              </h2>
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                {weekMovies.map((movie: any) => {
                  const filmaffinitySearch = `https://www.filmaffinity.com/es/search.php?stext=${encodeURIComponent(movie.title)}`;
                  const dateStr = new Date(
                    movie.release_date,
                  ).toLocaleDateString("es-ES");

                  return (
                    <a
                      href={filmaffinitySearch}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="group relative block"
                    >
                      <div class="aspect-[2/3] overflow-hidden rounded-lg bg-gray-200 dark:bg-gray-800 mb-3 shadow-sm hover:shadow-xl transition-all duration-300">
                        <img
                          src={`${imageBase}${movie.poster_path}`}
                          alt={movie.title}
                          class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                        />
                        <div class="absolute top-2 right-2 bg-black/80 backdrop-blur text-white text-xs font-bold px-2 py-1 rounded border border-white/20">
                          {movie.vote_average > 0
                            ? Math.round(movie.vote_average * 10) / 10 + " â˜…"
                            : "ESTRENO"}
                        </div>
                      </div>
                      <h3 class="font-bold text-gray-900 dark:text-white leading-tight hover:text-yellow-600 transition-colors">
                        {movie.title}
                      </h3>
                      <p class="text-xs text-gray-500 mt-1 font-mono">
                        ðŸ“… {dateStr}
                      </p>
                    </a>
                  );
                })}
              </div>
            </div>
          );
        })}
      </div>
    )
  }
</Layout>
