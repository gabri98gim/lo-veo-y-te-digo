---
import Layout from "../layouts/Layout.astro";

const apiKey = import.meta.env.TMDB_API_KEY;

let movies: any[] = [];
const today = new Date().toISOString().split("T")[0];

const sixWeeksLater = new Date();
sixWeeksLater.setDate(sixWeeksLater.getDate() + 42);
const maxDate = sixWeeksLater.toISOString().split("T")[0];

try {
  // üß™ PRUEBA: Sin with_release_type=3 para ver si ese es el problema
  const pages = [1, 2];
  const allResults: any[] = [];

  for (const page of pages) {
    // SIN el filtro with_release_type=3
    const upcomingResponse = await fetch(
      `https://api.themoviedb.org/3/discover/movie?api_key=${apiKey}&language=es-ES&region=ES&sort_by=primary_release_date.asc&primary_release_date.gte=${today}&primary_release_date.lte=${maxDate}&page=${page}`,
    );

    const upcomingData = await upcomingResponse.json();
    if (upcomingData.results) {
      allResults.push(...upcomingData.results);
    }
  }

  // Llamada 2: Pelis en cines ahora
  const nowPlayingResponse = await fetch(
    `https://api.themoviedb.org/3/movie/now_playing?api_key=${apiKey}&language=es-ES&region=ES&page=1`,
  );

  const nowPlayingData = await nowPlayingResponse.json();

  // Combinamos todas las listas
  const allMovies = [...allResults, ...(nowPlayingData.results || [])];

  // Eliminamos duplicados por ID
  const uniqueMovies = Array.from(
    new Map(allMovies.map((m: any) => [m.id, m])).values(),
  );

  movies = uniqueMovies
    // Solo futuras o muy recientes (√∫ltimos 3 d√≠as)
    .filter((m: any) => {
      const releaseDate = new Date(m.release_date);
      const todayDate = new Date(today);
      const threeDaysAgo = new Date(todayDate);
      threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
      return releaseDate >= threeDaysAgo && releaseDate <= sixWeeksLater;
    })
    // Filtro de calidad MUY suave
    .filter((m: any) => {
      const hasPoster = m.poster_path !== null;
      const hasMinActivity = m.popularity > 0.5 || m.vote_count > 0;
      return hasPoster && hasMinActivity;
    })
    // Ordenar por fecha
    .sort(
      (a: any, b: any) =>
        new Date(a.release_date).getTime() - new Date(b.release_date).getTime(),
    );
} catch (error) {
  console.error("üíÄ Error:", error);
}

// Agrupar por semanas
const groupByWeek = (movies: any[]) => {
  const weeks: { [key: string]: any[] } = {};

  movies.forEach((movie) => {
    const date = new Date(movie.release_date);
    const weekStart = new Date(date);
    weekStart.setDate(date.getDate() - date.getDay() + 1); // Lunes de esa semana
    const weekKey = weekStart.toISOString().split("T")[0];

    if (!weeks[weekKey]) {
      weeks[weekKey] = [];
    }
    weeks[weekKey].push(movie);
  });

  return Object.entries(weeks).sort(([a], [b]) => a.localeCompare(b));
};

const weekGroups = groupByWeek(movies);

const imageBase = "https://image.tmdb.org/t/p/w500";
---

<Layout title="Pr√≥ximos Estrenos | Lo veo y te digo">
  <section class="mb-12">
    <h1
      class="font-serif text-4xl font-bold text-gray-900 dark:text-white mb-4"
    >
      Pr√≥ximos Estrenos (Espa√±a)
    </h1>
    <p class="text-gray-600 dark:text-gray-400 max-w-2xl text-lg">
      Pel√≠culas que llegan a la cartelera desde hoy ({today}) hasta las pr√≥ximas
      6 semanas. <span class="text-xs">(Sin filtro release_type)</span>
    </p>
  </section>

  {
    movies.length === 0 ? (
      <div class="p-8 bg-gray-100 dark:bg-gray-800 text-gray-500 rounded-lg text-center">
        <p class="font-bold text-xl">
          No se han encontrado estrenos para los pr√≥ximos d√≠as üòî
        </p>
      </div>
    ) : (
      <div class="space-y-12">
        {weekGroups.map(([weekStart, weekMovies]) => {
          const weekDate = new Date(weekStart);
          const weekEnd = new Date(weekDate);
          weekEnd.setDate(weekEnd.getDate() + 6);

          const weekLabel = `${weekDate.toLocaleDateString("es-ES", { day: "numeric", month: "short" })} - ${weekEnd.toLocaleDateString("es-ES", { day: "numeric", month: "short" })}`;

          return (
            <div>
              <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-6 pb-2 border-b-2 border-cine-gold">
                {weekLabel}{" "}
                <span class="text-sm text-gray-500">
                  ({weekMovies.length} pel√≠culas)
                </span>
              </h2>
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                {weekMovies.map((movie: any) => {
                  const filmaffinitySearch = `https://www.filmaffinity.com/es/search.php?stext=${encodeURIComponent(movie.title)}`;
                  const dateStr = new Date(
                    movie.release_date,
                  ).toLocaleDateString("es-ES");

                  return (
                    <a
                      href={filmaffinitySearch}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="group relative block"
                    >
                      <div class="aspect-[2/3] overflow-hidden rounded-lg bg-gray-200 dark:bg-gray-800 mb-3 shadow-sm hover:shadow-xl transition-all duration-300">
                        {movie.poster_path ? (
                          <img
                            src={`${imageBase}${movie.poster_path}`}
                            alt={movie.title}
                            class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                          />
                        ) : (
                          <div class="w-full h-full flex items-center justify-center text-gray-400 text-xs">
                            Sin p√≥ster
                          </div>
                        )}
                        <div class="absolute top-2 right-2 bg-black/80 backdrop-blur text-white text-xs font-bold px-2 py-1 rounded border border-white/20">
                          {movie.vote_average > 0
                            ? Math.round(movie.vote_average * 10) / 10 + " ‚òÖ"
                            : "ESTRENO"}
                        </div>
                      </div>
                      <h3 class="font-bold text-gray-900 dark:text-white leading-tight group-hover:text-cine-gold transition-colors">
                        {movie.title}
                      </h3>
                      <p class="text-xs text-gray-500 mt-1 font-mono">
                        üìÖ {dateStr}
                      </p>
                    </a>
                  );
                })}
              </div>
            </div>
          );
        })}
      </div>
    )
  }
</Layout>
